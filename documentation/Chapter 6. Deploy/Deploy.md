# **6. Деплой (GitHub Actions)**

## **6.1. Обзор процесса деплоя**

В проекте реализован полностью автоматизированный процесс деплоя, который срабатывает при каждом коммите в ветку `main`. Весь процесс происходит без вмешательства человека и включает следующие этапы:

```
1. Коммит в ветку main → 2. Запуск GitHub Actions → 3. Сборка проекта → 4. Загрузка на FTP-сервер → 5. Готовый сайт
```

**Ключевые особенности:**
- **Автоматический запуск:** При любом push в ветку `main`
- **Статическая генерация:** Nuxt генерирует HTML файлы
- **FTP-деплой:** Загрузка файлов на хостинг
- **Безопасность:** Данные FTP защищены через GitHub Secrets
- **Отказоустойчивость:** Timeout 30 минут, проверка сборки

## **6.2. Конфигурация GitHub Actions (разбор файла `.github/workflows/main.yml`)**

### **Полный код workflow:**

```yaml
name: Deploy to FTP

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'docs/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: |
          npm run generate || (echo "Build failed" && exit 1)
          echo "Build completed"

      - name: Verify build output
        run: |
          echo "Checking build output directory..."
          ls -la .output/
          ls -la .output/public/ || echo "No public directory"
          echo "Directory tree:"
          find .output/ -type d

      - name: FTP Deploy
        if: success()
        uses: SamKirkland/FTP-Deploy-Action@4.2.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: .output/public/
          server-dir: /
          exclude: '**/.git*'
```

### **Подробный разбор каждой секции**

#### **Триггеры запуска (`on:`):**
```yaml
on:
  push:
    branches:
      - main           # Только для ветки main
    paths-ignore:      # Игнорируемые пути
      - 'README.md'    # README не влияет на сайт
      - 'docs/**'      # Вся папка документации
```

**Что это значит:**
- Workflow запускается только при пуше в ветку `main`
- Изменения в README.md и папке docs не запускают деплой
- Это оптимизация для экономии времени сборки

#### **Настройка окружения:**
```yaml
jobs:
  deploy:
    runs-on: ubuntu-latest    # Последняя версия Ubuntu
    timeout-minutes: 30       # Максимальное время выполнения
```

**Спецификация:**
- **ОС:** Ubuntu Linux (последняя стабильная версия)
- **Время выполнения:** 30 минут максимум
- **Если дольше:** GitHub автоматически отменяет выполнение

#### **Шаг 1: Получение кода**
```yaml
- name: Checkout code
  uses: actions/checkout@v3
```

**Что происходит:**
- GitHub Actions клонирует репозиторий
- Используется конкретная версия action (v3)
- Код становится доступен в виртуальной машине

#### **Шаг 2: Установка Node.js**
```yaml
- name: Setup Node.js
  uses: actions/setup-node@v3
  with:
    node-version: '20'
```

**Важные моменты:**
- Устанавливается Node.js версии 20 (LTS)
- Совместимость с проектом гарантирована
- Все зависимости будут установлены под эту версию

#### **Шаг 3: Установка зависимостей**
```yaml
- name: Install dependencies
  run: npm ci
```

**Почему `npm ci`, а не `npm install`:**
- `ci` (clean install) быстрее и надежнее
- Использует точные версии из `package-lock.json`
- Удаляет `node_modules` перед установкой
- Гарантирует воспроизводимость сборки

#### **Шаг 4: Сборка проекта**
```yaml
- name: Build project
  run: |
    npm run generate || (echo "Build failed" && exit 1)
    echo "Build completed"
```

**Команда `npm run generate`:**
- Генерирует статические HTML файлы
- Обрабатывает все Markdown, YAML, JSON файлы
- Создает файлы в папке `.output/public/`

**Обработка ошибок:**
- `||` - оператор "ИЛИ", выполняет следующую команду если первая завершилась с ошибкой
- При ошибке сборки выводится сообщение и процесс завершается

#### **Шаг 5: Проверка результатов сборки**
```yaml
- name: Verify build output
  run: |
    echo "Checking build output directory..."
    ls -la .output/
    ls -la .output/public/ || echo "No public directory"
    echo "Directory tree:"
    find .output/ -type d
```

**Зачем это нужно:**
- Убедиться, что сборка прошла успешно
- Проверить наличие и структуру выходных файлов
- Диагностика проблем при сбое деплоя

**Ожидаемый вывод:**
```
.output/
└── public/
    ├── index.html
    ├── clinic/
    │   ├── index.html
    │   └── about/
    │       └── index.html
    └── _nuxt/
```

#### **Шаг 6: Загрузка на FTP-сервер**
```yaml
- name: FTP Deploy
  if: success()
  uses: SamKirkland/FTP-Deploy-Action@4.2.0
  with:
    server: ${{ secrets.FTP_SERVER }}
    username: ${{ secrets.FTP_USERNAME }}
    password: ${{ secrets.FTP_PASSWORD }}
    local-dir: .output/public/
    server-dir: /
    exclude: '**/.git*'
```

**Ключевые параметры:**
- `if: success()` - выполняется только если предыдущие шаги успешны
- `server` - адрес FTP-сервера (из секретов)
- `local-dir` - локальная папка с собранными файлами
- `server-dir` - корневая папка на сервере (`/` = корень сайта)
- `exclude` - исключаем файлы `.git`

## **6.3. Настройка секретов (Secrets) в репозитории**

### **Необходимые секреты**

Для работы деплоя нужно настроить 3 секрета в GitHub:

| Секрет | Описание | Пример значения |
|--------|----------|-----------------|
| `FTP_SERVER` | Адрес FTP-сервера | `ftp.example.com` |
| `FTP_USERNAME` | Имя пользователя FTP | `username` |
| `FTP_PASSWORD` | Пароль FTP | `secure_password_123` |

### **Как добавить секреты:**

1. **Перейдите в настройки репозитория:**
    - Откройте репозиторий на GitHub
    - Нажмите "Settings" (вкладка справа вверху)

2. **Найдите раздел Secrets:**
    - В левом меню выберите "Secrets and variables"
    - Нажмите "Actions"

3. **Добавьте каждый секрет:**
    - Нажмите "New repository secret"
    - **Name:** `FTP_SERVER`
    - **Secret:** Ваш FTP-адрес (например, `ftp.hosting.ru`)
    - Нажмите "Add secret"

4. **Повторите для всех трех секретов**

**Важные замечания:**
- Секреты **никогда** не показываются в логах
- Доступны только во время выполнения workflow
- Можно обновлять, но нельзя просматривать старые значения
- При смене хостинга нужно обновить все три секрета

### **Где взять данные для FTP:**

**Для большинства хостингов:**
1. Войдите в панель управления хостингом (cPanel, ISPmanager и т.д.)
2. Найдите раздел "FTP аккаунты" или "Доступ к FTP"
3. Используйте данные:
    - Сервер: `ftp.ваш-домен.ru` или IP-адрес
    - Имя пользователя: полный логин (часто `user@domain.ru`)
    - Пароль: пароль FTP-пользователя

**Проверка FTP-доступа:**
```bash
# Команда для проверки (в терминале):
ftp ftp.ваш-домен.ru
# Введите логин и пароль
```

## **6.4. Мониторинг деплоя**

### **Где смотреть статус деплоя**

1. **Вкладка Actions:**
   ```
   https://github.com/klinika-zdorovya/web/actions
   ```

2. **Конкретный workflow:**
    - Нажмите на название workflow "Deploy to FTP"
    - Видите список последних запусков

3. **Детали выполнения:**
    - Нажмите на конкретный запуск
    - Видите все шаги и их статус

### **Чтение логов**

**Успешный деплой:**
```
✓ FTP Deploy
  Connected to server
  Uploading 147 files...
  Upload complete
  Summary: Created 12, Updated 135, Deleted 0
```

**Проблемы с подключением:**
```
✗ FTP Deploy
  Error: Timeout (control socket)
  Could not connect to server
```

**Проблемы с аутентификацией:**
```
✗ FTP Deploy
  Error: Login incorrect
  530 Login authentication failed
```

### **Время выполнения**

**Типичное время:**
- Установка зависимостей: 1-2 минуты
- Сборка проекта: 2-5 минут
- Загрузка на FTP: 1-3 минуты
- **Итого:** 5-10 минут

**Факторы, влияющие на время:**
- Количество страниц (чем больше, тем дольше сборка)
- Размер изображений
- Скорость интернета GitHub Actions
- Скорость FTP-сервера

## **6.5. Устранение неполадок**

### **Проблема 1: Сборка не удалась**

**Симптомы:**
```
✗ Build project
  npm ERR! code ELIFECYCLE
  npm ERR! errno 1
```

**Возможные причины и решения:**

**1. Ошибки в контенте:**
```yaml
# Неправильный YAML:
documents:
  - title: Документ 1
  url: '/images/doc.jpg'  # ОШИБКА: неправильный отступ

# Правильно:
documents:
  - title: Документ 1
    url: '/images/doc.jpg'
```

**2. Отсутствуют зависимости:**
```bash
# Решение: Проверить package.json
npm install --save-dev @nuxt/content
```

**3. Проблемы с Node.js версией:**
```yaml
# В workflow.yml убедитесь, что версия совместима
node-version: '20'  # Должно быть 18, 20 или выше
```

### **Проблема 2: FTP-подключение не удается**

**Симптомы:**
```
Error: Timeout (control socket)
```

**Решение:**

1. **Проверьте секреты:**
    - Убедитесь, что `FTP_SERVER`, `FTP_USERNAME`, `FTP_PASSWORD` правильные
    - Проверьте, нет ли опечаток

2. **Проверьте FTP-доступ:**
    - Попробуйте подключиться через FTP-клиент (FileZilla)
    - Убедитесь, что сервер доступен

3. **Настройки FTP-сервера:**
    - Проверьте, не требуется ли пассивный режим
    - Убедитесь, что нет брандмауэра, блокирующего подключение

4. **Измените таймаут (расширенное решение):**
   ```yaml
   # Добавьте параметры в шаг FTP Deploy:
   with:
     server: ${{ secrets.FTP_SERVER }}
     # ... остальные параметры
     timeout: 120000  # 120 секунд в миллисекундах
   ```

### **Проблема 3: Файлы не загружаются**

**Симптомы:**
```
Upload complete
Summary: Created 0, Updated 0, Deleted 0
```

**Решение:**

1. **Проверьте локальную папку:**
    - Убедитесь, что сборка создала файлы в `.output/public/`
    - Проверьте шаг "Verify build output"

2. **Проверьте путь на сервере:**
   ```yaml
   server-dir: /public_html/  # Возможно, нужен конкретный путь
   ```

3. **Проверьте права доступа на сервере:**
    - Убедитесь, что FTP-пользователь имеет права на запись
    - Проверьте квоты дискового пространства

### **Проблема 4: Деплой слишком медленный**

**Оптимизации:**

1. **Кэширование зависимостей:**
   ```yaml
   # Добавьте шаг кэширования после Setup Node.js
   - name: Cache dependencies
     uses: actions/cache@v3
     with:
       path: ~/.npm
       key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
       restore-keys: |
         ${{ runner.os }}-node-
   ```

2. **Увеличение таймаута:**
   ```yaml
   deploy:
     runs-on: ubuntu-latest
     timeout-minutes: 45  # Увеличьте при необходимости
   ```

3. **Исключение ненужных файлов:**
   ```yaml
   # Добавьте в секцию with FTP Deploy:
   exclude: |
     **/.git*
     **/.github/*
     **/*.log
     **/test/*
   ```

### **Проблема 5: Изменения не отображаются на сайте**

**Причины и решения:**

1. **Кэширование на стороне сервера/CDN:**
    - Очистите кэш хостинга
    - Подождите 10-15 минут

2. **Кэширование браузера:**
    - Используйте Ctrl+F5 для принудительной перезагрузки
    - Проверьте в режиме инкогнито

3. **Проблемы с путями:**
    - Проверьте, что файлы загрузились в правильную папку
    - Убедитесь, что нет конфликта с предыдущими версиями

## **6.6. Расширенные настройки**

### **Деплой только при изменении определенных файлов**

```yaml
on:
  push:
    branches:
      - main
    paths:
      - 'content/**'      # Только изменения в контенте
      - 'public/images/**' # Или изменения изображений
      - 'nuxt.config.ts'  # Или конфигурации
```

### **Ручной запуск деплоя**

```yaml
on:
  push:
    branches: [main]
  workflow_dispatch:  # Позволяет запускать вручную
    inputs:
      reason:
        description: 'Причина ручного запуска'
        required: true
        default: 'Обновление контента'
```

**Как использовать:**
1. Перейдите в Actions → Deploy to FTP
2. Нажмите "Run workflow"
3. Выберите ветку и укажите причину
4. Нажмите "Run workflow"

### **Уведомления о деплое**

```yaml
# Добавьте в конец файла:
notify:
  - name: Send notification
    if: always()  # Даже при ошибке
    run: |
      # Отправка в Telegram/Slack/Email
      echo "Деплой завершен со статусом: ${{ job.status }}"
```

## **6.7. Безопасность**

### **Рекомендации по безопасности**

1. **Регулярно обновляйте зависимости:**
   ```bash
   npm update
   npm audit fix
   ```

2. **Проверяйте секреты:**
    - Не храните FTP-пароли в коде
    - Используйте GitHub Secrets
    - Регулярно меняйте пароли

3. **Ограничивайте доступ:**
    - Минимальное количество людей с доступом к репозиторию
    - Регулярный аудит прав доступа

### **Резервное копирование**

**Автоматические бэкапы:**
1. Сам GitHub хранит историю всех файлов
2. Каждый коммит - это версия
3. Можно восстановить любую предыдущую версию

**Дополнительные бэкапы:**
```yaml
# Добавьте шаг создания архива
- name: Create backup archive
  run: |
    tar -czf backup-$(date +%Y%m%d-%H%M%S).tar.gz .output/public/
    # Можно загрузить как артефакт
```

## **6.8. Часто задаваемые вопросы (FAQ)**

### **Q: Сколько стоит использование GitHub Actions?**
**A:** Для публичных репозиториев (как наш) GitHub Actions бесплатен с лимитом 2000 минут в месяц. Наш деплой занимает ~10 минут, поэтому лимит не будет превышен.

### **Q: Можно ли деплоить на другой хостинг?**
**A:** Да, можно настроить деплой на:
- GitHub Pages
- Netlify
- Vercel
- AWS S3
- Любой другой сервер по SSH или FTP

### **Q: Что делать, если хостинг сменился?**
**A:**
1. Обновите секреты `FTP_SERVER`, `FTP_USERNAME`, `FTP_PASSWORD`
2. Проверьте подключение
3. Запустите деплой вручную

### **Q: Как откатить изменения, если деплой прошел с ошибкой?**
**A:**
1. Восстановите предыдущую версию файлов через Git
2. Сделайте коммит с исправлениями
3. Автоматически запустится новый деплой

### **Q: Можно ли деплоить только определенные страницы?**
**A:** Nuxt генерирует весь сайт целиком. Для частичного обновления нужно:
- Сделать изменения только в нужных файлах
- Весь сайт будет перегенерирован, но обновятся только измененные страницы

### **Q: Как ускорить деплой?**
**A:**
1. Оптимизируйте изображения
2. Уменьшите количество страниц (если возможно)
3. Используйте кэширование зависимостей
4. Настройте инкрементальную сборку (продвинутая настройка)

---

**В следующем разделе** рассмотрим **"Для разработчиков: Расширение функциональности"**, где опишем, как добавлять новые разделы, создавать компоненты, изменять стили и интегрировать внешние сервисы.